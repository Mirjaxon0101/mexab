<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Chat Sayt — Profil</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-r from-blue-500 to-purple-600 min-h-screen flex flex-col items-center text-white">

  <!-- Navbar -->
  <header class="w-full p-4 bg-black/30 backdrop-blur-md fixed top-0 left-0 flex justify-between items-center shadow-lg z-40">
    <h1 class="text-2xl font-bold">Chat Sayt</h1>
    <div class="space-x-2">
      <button onclick="openSignup()" class="px-4 py-2 bg-green-500 text-white rounded-xl font-semibold hover:bg-green-600 transition">
        Ro‘yxatdan o‘tish
      </button>
      <button onclick="openLogin()" class="px-4 py-2 bg-white text-black rounded-xl font-semibold hover:bg-gray-200 transition">
        Kirish
      </button>
    </div>
  </header>

  <!-- Asosiy content -->
  <main class="text-center mt-32 w-full max-w-3xl px-6">
    <h2 class="text-5xl font-extrabold drop-shadow-lg">Xush kelibsiz!</h2>
    <p class="mt-4 text-lg">Ro‘yxatdan o‘ting yoki kirib chatni boshlang. Profil sozlamalarida rasm yuklashingiz, parolni o'zgartirishingiz va akkauntingizni o'chirishingiz mumkin.</p>
  </main>

  <!-- Signup modal -->
  <div id="signupModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
    <div class="bg-white text-black p-6 rounded-2xl w-96 shadow-2xl relative">
      <button onclick="closeSignup()" class="absolute top-3 right-3 text-gray-500 hover:text-red-600 text-xl font-bold">✕</button>
      <h2 class="text-2xl font-bold mb-4">Ro‘yxatdan o‘tish</h2>

      <label class="block text-sm text-gray-600 mb-1">Ism</label>
      <input id="signupName" type="text" placeholder="Ismingiz"
        class="w-full px-3 py-2 border rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-green-500">

      <label class="block text-sm text-gray-600 mb-1">Parol</label>
      <input id="signupPass" type="password" placeholder="Parol"
        class="w-full px-3 py-2 border rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-green-500">

      <label class="block text-sm text-gray-600 mb-1">Profil rasmi (ixtiyoriy)</label>
      <input id="signupAvatar" type="file" accept="image/*" class="w-full mb-4">

      <button onclick="signup()" class="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
        Ro‘yxatdan o‘tish
      </button>
    </div>
  </div>

  <!-- Login modal -->
  <div id="loginModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
    <div class="bg-white text-black p-6 rounded-2xl w-96 shadow-2xl relative">
      <button onclick="closeLogin()" class="absolute top-3 right-3 text-gray-500 hover:text-red-600 text-xl font-bold">✕</button>
      <h2 class="text-2xl font-bold mb-4">Kirish</h2>
      <label class="block text-sm text-gray-600 mb-1">Ism</label>
      <input id="loginName" type="text" placeholder="Ismingiz"
        class="w-full px-3 py-2 border rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-purple-500">
      <label class="block text-sm text-gray-600 mb-1">Parol</label>
      <input id="loginPass" type="password" placeholder="Parol"
        class="w-full px-3 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-purple-500">
      <div class="flex gap-2">
        <button onclick="login()" class="flex-1 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">Kirish</button>
        <button onclick="switchToSignup()" class="flex-1 py-2 bg-gray-200 text-black rounded-lg hover:bg-gray-300 transition">Ro‘yxatdan</button>
      </div>
    </div>
  </div>

  <!-- Profile modal -->
  <div id="profileModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
    <div class="bg-white text-black p-6 rounded-2xl w-96 shadow-2xl relative">
      <button onclick="closeProfile()" class="absolute top-3 right-3 text-gray-500 hover:text-red-600 text-xl font-bold">✕</button>
      <h2 class="text-2xl font-bold mb-3">Profil sozlamalari</h2>

      <div class="flex items-center gap-4 mb-4">
        <img id="profileAvatarPreview" src="" alt="avatar" class="w-16 h-16 rounded-full object-cover bg-gray-100 border">
        <div class="flex-1">
          <div id="profileNameDisplay" class="font-semibold text-lg"></div>
          <label class="text-sm text-gray-600">Rasmni yangilash</label>
          <input id="profileAvatarInput" type="file" accept="image/*" class="w-full mt-1">
        </div>
      </div>

      <hr class="my-3">

      <label class="block text-sm text-gray-600 mb-1">Joriy parolni kiriting</label>
      <input id="currentPass" type="password" placeholder="Joriy parol"
        class="w-full px-3 py-2 border rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
      <label class="block text-sm text-gray-600 mb-1">Yangi parol</label>
      <input id="newPass" type="password" placeholder="Yangi parol"
        class="w-full px-3 py-2 border rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">

      <button onclick="changePassword()" class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition mb-3">Parolni o'zgartirish</button>

      <button onclick="deleteAccount()" class="w-full py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Akkauntni o'chirish</button>
    </div>
  </div>

  <!-- Fullscreen chat -->
  <div id="chatScreen" class="hidden fixed inset-0 bg-gradient-to-r from-gray-900 via-purple-900 to-black flex z-30">
    <!-- Foydalanuvchilar paneli -->
    <aside class="w-72 bg-black/50 p-4 border-r border-gray-700 overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold">Foydalanuvchilar</h2>
        <div>
          <button id="openProfileBtn" onclick="openProfile()" class="px-3 py-1 bg-indigo-600 rounded-lg text-sm hover:bg-indigo-700">Profil</button>
        </div>
      </div>
      <ul id="userList" class="space-y-3 text-gray-200"></ul>
    </aside>

    <!-- Chat qismi -->
    <div class="flex-1 flex flex-col">
      <header class="p-4 bg-black/40 text-white flex justify-between items-center">
        <h2 class="text-xl font-bold">Chat</h2>
        <button onclick="closeChat()" class="px-3 py-1 bg-red-600 rounded-lg hover:bg-red-700 transition">Chiqish</button>
      </header>
      <div id="messages" class="flex-1 p-6 overflow-y-auto space-y-3"></div>
      <footer class="p-4 bg-black/40 flex gap-2">
        <input id="messageInput" type="text" placeholder="Xabar yozing..."
          class="flex-1 px-3 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-purple-500">
        <button onclick="sendMessage()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">Yubor</button>
      </footer>
    </div>
  </div>

<script>
/* ====== LocalStorage struktura ======
users = [ { username: "...", password: "...", avatar: "data:image/..." } ]
chatHistory = [ { user: "...", text: "...", time: 123 } ]
======================================= */

let currentUser = null;

/* --- Modal funksiyalari --- */
function openSignup(){ document.getElementById('signupModal').classList.remove('hidden'); }
function closeSignup(){ document.getElementById('signupModal').classList.add('hidden'); }
function openLogin(){ document.getElementById('loginModal').classList.remove('hidden'); }
function closeLogin(){ document.getElementById('loginModal').classList.add('hidden'); }
function openProfile(){ if(!currentUser) return; document.getElementById('profileModal').classList.remove('hidden'); populateProfileModal(); }
function closeProfile(){ document.getElementById('profileModal').classList.add('hidden'); }

/* --- Ro‘yxatdan o‘tish --- */
function signup(){
  const name = document.getElementById('signupName').value.trim();
  const pass = document.getElementById('signupPass').value.trim();
  const avatarFile = document.getElementById('signupAvatar').files[0];
  if(!name || !pass){ alert('Ism va parol kiriting!'); return; }
  let users = JSON.parse(localStorage.getItem('users')) || [];
  if(users.find(u => u.username === name)){ alert('Bu ism allaqachon ro‘yxatdan o‘tgan!'); return; }
  if(avatarFile){
    const reader = new FileReader();
    reader.onload = function(e){
      users.push({ username: name, password: pass, avatar: e.target.result });
      localStorage.setItem('users', JSON.stringify(users));
      alert('Muvaffaqiyatli ro‘yxatdan o‘tdingiz!');
      closeSignup();
    };
    reader.readAsDataURL(avatarFile);
  } else {
    users.push({ username: name, password: pass, avatar: null });
    localStorage.setItem('users', JSON.stringify(users));
    alert('Muvaffaqiyatli ro‘yxatdan o‘tdingiz!');
    closeSignup();
  }
}

/* --- Kirish --- */
function login(){
  const name = document.getElementById('loginName').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  let users = JSON.parse(localStorage.getItem('users')) || [];
  const found = users.find(u => u.username === name && u.password === pass);
  if(found){
    currentUser = name;
    closeLogin();
    document.getElementById('chatScreen').classList.remove('hidden');
    loadMessages();
    loadUsers();
  } else { alert('Ism yoki parol noto‘g‘ri!'); }
}

/* --- Chiqish --- */
function closeChat(){ document.getElementById('chatScreen').classList.add('hidden'); currentUser = null; }

/* --- Xabar yuborish --- */
function sendMessage(){
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  if(!text || !currentUser) return;
  const newMsg = { user: currentUser, text, time: Date.now() };
  let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
  chatHistory.push(newMsg);
  localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
  input.value = "";
  loadMessages();
}

/* --- Xabarlarni yuklash --- */
function loadMessages(){
  const messagesArr = JSON.parse(localStorage.getItem('chatHistory')) || [];
  const messages = document.getElementById('messages');
  messages.innerHTML = '';
  messagesArr.forEach(m=>{
    const div = document.createElement('div');
    div.className = 'flex ' + (m.user===currentUser ? 'justify-end' : 'justify-start');
    div.innerHTML = `<div class="px-4 py-2 rounded-2xl max-w-xs ${m.user===currentUser?'bg-purple-600':'bg-gray-700'} text-white shadow">
      <strong>${escapeHtml(m.user)}</strong><br>${escapeHtml(m.text)}
    </div>`;
    messages.appendChild(div);
  });
  messages.scrollTop = messages.scrollHeight;
}

/* --- Foydalanuvchilar ro‘yxati --- */
function loadUsers(){
  let users = JSON.parse(localStorage.getItem('users')) || [];
  const list = document.getElementById('userList');
  list.innerHTML = '';
  users.forEach(u=>{
    const li = document.createElement('li');
    li.className = 'flex items-center gap-2 p-2 bg-gray-700 rounded-lg';
    li.innerHTML = `<img src="${u.avatar || 'https://via.placeholder.com/40'}" class="w-8 h-8 rounded-full"><span>${u.username}</span>`;
    list.appendChild(li);
  });
}

/* --- Profil ma’lumotlari --- */
function populateProfileModal(){
  let users = JSON.parse(localStorage.getItem('users')) || [];
  const u = users.find(x=>x.username===currentUser);
  if(!u) return;
  document.getElementById('profileNameDisplay').innerText = u.username;
  document.getElementById('profileAvatarPreview').src = u.avatar || 'https://via.placeholder.com/80';
  document.getElementById('profileAvatarInput').onchange = function(e){
    const file = e.target.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = ev=>{
        u.avatar = ev.target.result;
        localStorage.setItem('users', JSON.stringify(users));
        populateProfileModal(); loadUsers();
      };
      reader.readAsDataURL(file);
    }
  };
}

/* --- Parolni o‘zgartirish --- */
function changePassword(){
  const cur = document.getElementById('currentPass').value.trim();
  const neu = document.getElementById('newPass').value.trim();
  let users = JSON.parse(localStorage.getItem('users')) || [];
  const u = users.find(x=>x.username===currentUser);
  if(!u) return;
  if(u.password!==cur){ alert('Joriy parol noto‘g‘ri!'); return; }
  u.password = neu;
  localStorage.setItem('users', JSON.stringify(users));
  alert('Parol o‘zgartirildi!');
  closeProfile();
}

/* --- Akkauntni o‘chirish --- */
function deleteAccount(){
  if(!confirm('Akkauntingizni o‘chirishni xohlaysizmi?')) return;
  let users = JSON.parse(localStorage.getItem('users')) || [];
  users = users.filter(u=>u.username!==currentUser);
  localStorage.setItem('users', JSON.stringify(users));
  let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
  chatHistory = chatHistory.filter(m=>m.user!==currentUser);
  localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
  alert('Akkaunt o‘chirildi');
  closeProfile(); closeChat();
}

/* --- HTML xavfsizlik uchun --- */
function escapeHtml(str){ return str.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }
</script>
</body>
</html>
